<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Adaptativo Integrado - Teste Real</title>

    <!-- CDNs Externos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Fontes e Estilos Locais -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .integration-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .integration-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .integration-header h1 {
            font-size: 2.5rem;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .integration-header p {
            font-size: 1.2rem;
            color: #6b7280;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .test-card {
            border: 3px solid #e5e7eb;
            border-radius: 15px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            background: #f9fafb;
        }

        .test-card:hover {
            border-color: #3b82f6;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2);
        }

        .test-card.active {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .test-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .test-title {
            font-size: 1.6rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 15px;
        }

        .test-description {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .test-features {
            background: #f3f4f6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
            font-size: 0.9rem;
        }

        .test-features h4 {
            font-weight: bold;
            margin-bottom: 10px;
            color: #1f2937;
        }

        .test-features ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .test-features li {
            margin-bottom: 5px;
            color: #4b5563;
        }

        .test-features li:before {
            content: "‚úì ";
            color: #10b981;
            font-weight: bold;
        }

        .start-integration-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px 40px;
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 30px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .start-integration-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
        }

        .start-integration-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-section {
            margin-top: 50px;
            padding: 30px;
            background: #f8fafc;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
        }

        .status-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .status-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .status-item.connected {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .status-item.disconnected {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .status-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .status-label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .demo-mode-toggle {
            margin-top: 20px;
            text-align: center;
        }

        .demo-mode-toggle label {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: bold;
            color: #4b5563;
        }

        .demo-mode-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        /* Esconde elementos do sistema original */
        .screen {
            display: none !important;
        }

        .hidden {
            display: none !important;
        }

        .adaptive-game-container {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 9999 !important;
        }
    </style>
</head>
<body>
    <div class="integration-container">
        <div class="integration-header">
            <h1>üéØ Sistema Adaptativo Integrado</h1>
            <p>Teste do sistema completo de jogos adaptativos integrado ao banco de dados</p>
        </div>

        <div class="test-grid" id="test-grid">
            <div class="test-card" data-test-type="real-students">
                <div class="test-icon">üë®‚Äçüéì</div>
                <div class="test-title">Estudantes Reais</div>
                <div class="test-description">
                    Teste com estudantes reais do banco de dados Supabase.
                    Conte√∫do adaptativo carregado dinamicamente baseado nas necessidades individuais.
                </div>
                <div class="test-features">
                    <h4>Recursos Testados:</h4>
                    <ul>
                        <li>Carregamento de dados reais do Supabase</li>
                        <li>Textos de apoio adaptativos</li>
                        <li>Quest√µes personalizadas por tipo</li>
                        <li>8 jogos adaptativos diferentes</li>
                        <li>Feedback personalizado do banco</li>
                    </ul>
                </div>
            </div>

            <div class="test-card" data-test-type="mock-demo">
                <div class="test-icon">üß™</div>
                <div class="test-title">Demonstra√ß√£o Completa</div>
                <div class="test-description">
                    Demonstra√ß√£o com dados de exemplo para testar todos os recursos
                    sem precisar de conex√£o com banco de dados.
                </div>
                <div class="test-features">
                    <h4>Recursos Testados:</h4>
                    <ul>
                        <li>6 perfis de estudantes diferentes</li>
                        <li>Todos os tipos de adapta√ß√£o</li>
                        <li>Sistema de escolha de atividades</li>
                        <li>Progress√£o e recompensas</li>
                        <li>Interface adaptativa completa</li>
                    </ul>
                </div>
            </div>

            <div class="test-card" data-test-type="content-creation">
                <div class="test-icon">üîß</div>
                <div class="test-title">Cria√ß√£o de Conte√∫do</div>
                <div class="test-description">
                    Interface para criar e testar novos conte√∫dos adaptativos
                    diretamente no banco de dados.
                </div>
                <div class="test-features">
                    <h4>Recursos Dispon√≠veis:</h4>
                    <ul>
                        <li>Cria√ß√£o de textos adaptativos</li>
                        <li>Formul√°rio de quest√µes</li>
                        <li>Designer de jogos</li>
                        <li>Preview em tempo real</li>
                        <li>Salvamento no Supabase</li>
                    </ul>
                </div>
            </div>
        </div>

        <button id="start-integration-btn" class="start-integration-btn" disabled>
            üöÄ Iniciar Teste Selecionado
        </button>

        <div class="demo-mode-toggle">
            <label>
                <input type="checkbox" id="force-mock-data" />
                For√ßar uso de dados mock (para testes offline)
            </label>
        </div>

        <div class="status-section">
            <div class="status-title">Status do Sistema</div>
            <div class="status-grid" id="status-grid">
                <!-- Status ser√° preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Container para os jogos -->
    <div id="adaptive-game-container" class="hidden"></div>

    <!-- Script de integra√ß√£o -->
    <script type="module">
        // Importa m√≥dulos necess√°rios
        import { state, updateState } from './src/state.js';
        import { showScreen } from './src/navigation.js';
        import { dataService } from './src/services/dataService.js';
        import { routeAssessment } from './src/adaptation.js';

        // Estado da integra√ß√£o
        let selectedTestType = null;
        let systemStatus = {
            supabase: false,
            adaptiveContent: false,
            gameSystem: false
        };

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeIntegration();
            setupEventListeners();
            updateSystemStatus();
        });

        async function initializeIntegration() {
            console.log('üöÄ Inicializando Sistema Adaptativo Integrado');

            // Mock b√°sico do estado global
            window.state = {
                currentStudent: null,
                currentGrade: 6,
                currentAssessment: null,
                score: 0,
                answerLog: []
            };

            window.dom = {};

            // Mock das fun√ß√µes principais
            window.updateState = function(newState) {
                Object.assign(window.state, newState);
                console.log('Estado atualizado:', newState);
            };

            window.showScreen = function(screenName) {
                console.log('Mudando para tela:', screenName);

                if (screenName === 'adaptation-choice') {
                    document.getElementById('adaptive-game-container').classList.remove('hidden');
                    document.querySelector('.integration-container').style.display = 'none';
                }
            };

            window.finishAssessment = function() {
                console.log('üéâ Avalia√ß√£o finalizada!');
                alert('üéâ Avalia√ß√£o conclu√≠da com sucesso!\\n\\nO estudante foi redirecionado para os resultados.');

                // Volta para a tela de integra√ß√£o
                document.getElementById('adaptive-game-container').classList.add('hidden');
                document.querySelector('.integration-container').style.display = 'block';

                // Limpa sele√ß√£o
                selectedTestType = null;
                document.querySelectorAll('.test-card').forEach(card => {
                    card.classList.remove('active');
                });
                document.getElementById('start-integration-btn').disabled = true;
            };

            console.log('‚úÖ Sistema inicializado');
        }

        function setupEventListeners() {
            // Sele√ß√£o de tipo de teste
            document.querySelectorAll('.test-card').forEach(card => {
                card.addEventListener('click', () => selectTestType(card));
            });

            // Bot√£o de iniciar
            document.getElementById('start-integration-btn').addEventListener('click', startSelectedTest);

            // Toggle de dados mock
            document.getElementById('force-mock-data').addEventListener('change', (e) => {
                localStorage.setItem('forceMockData', e.target.checked ? 'true' : 'false');
                updateSystemStatus();
            });
        }

        function selectTestType(cardElement) {
            // Remove sele√ß√£o anterior
            document.querySelectorAll('.test-card').forEach(card => {
                card.classList.remove('active');
            });

            // Seleciona novo tipo
            cardElement.classList.add('active');
            selectedTestType = cardElement.dataset.testType;

            // Habilita bot√£o
            document.getElementById('start-integration-btn').disabled = false;

            console.log('Tipo de teste selecionado:', selectedTestType);
        }

        async function startSelectedTest() {
            if (!selectedTestType) {
                alert('Por favor, selecione um tipo de teste primeiro!');
                return;
            }

            console.log('üéÆ Iniciando teste:', selectedTestType);

            try {
                switch (selectedTestType) {
                    case 'real-students':
                        await startRealStudentsTest();
                        break;
                    case 'mock-demo':
                        await startMockDemoTest();
                        break;
                    case 'content-creation':
                        await startContentCreationTest();
                        break;
                    default:
                        throw new Error('Tipo de teste n√£o reconhecido');
                }
            } catch (error) {
                console.error('Erro ao iniciar teste:', error);
                alert('Erro ao iniciar teste: ' + error.message);
            }
        }

        async function startRealStudentsTest() {
            console.log('üéØ Iniciando teste com estudantes reais...');

            // Testa conex√£o com banco
            try {
                const classes = await dataService.getClassesByGrade(6);
                if (!classes || classes.length === 0) {
                    throw new Error('Nenhuma turma encontrada no banco');
                }

                const students = await dataService.getStudentsByClass(classes[0].id);
                if (!students || students.length === 0) {
                    throw new Error('Nenhum estudante encontrado');
                }

                // Encontra estudante com adapta√ß√£o
                const adaptiveStudent = students.find(s => s.adaptation_details);
                if (!adaptiveStudent) {
                    throw new Error('Nenhum estudante com adapta√ß√£o encontrado');
                }

                console.log('‚úÖ Estudante adaptativo encontrado:', adaptiveStudent.name);

                // Simula sele√ß√£o do estudante
                window.state.currentStudent = {
                    ...adaptiveStudent,
                    grade: 6
                };

                // Carrega avalia√ß√£o real
                const assessment = await dataService.getAssessmentData(6, 'Artes');
                if (!assessment) {
                    throw new Error('Avalia√ß√£o n√£o encontrada');
                }

                console.log('‚úÖ Avalia√ß√£o carregada:', assessment.title);

                // Inicia roteamento adaptativo
                await routeAssessment(assessment);

            } catch (error) {
                console.error('Erro no teste real:', error);
                alert('Erro no teste com dados reais: ' + error.message + '\\n\\nVerifique a conex√£o com o Supabase.');
            }
        }

        async function startMockDemoTest() {
            console.log('üß™ Iniciando demonstra√ß√£o com dados mock...');

            // For√ßa uso de dados mock
            localStorage.setItem('forceMockData', 'true');

            // Estudantes de demonstra√ß√£o
            const demoStudents = [
                {
                    id: 'demo-1',
                    name: 'Ana (TEA)',
                    adaptationDetails: JSON.stringify({
                        diagnosis: ['TEA', 'Autismo'],
                        difficulties: ['concentra√ß√£o', 'textos longos'],
                        suggestions: ['textos curtos', 'poucas alternativas']
                    }),
                    grade: 6
                },
                {
                    id: 'demo-2',
                    name: 'Carlos (TDAH)',
                    adaptationDetails: JSON.stringify({
                        diagnosis: ['TDAH', 'Hiperatividade'],
                        difficulties: ['aten√ß√£o', 'concentra√ß√£o'],
                        suggestions: ['atividades din√¢micas', 'pausas frequentes']
                    }),
                    grade: 6
                },
                {
                    id: 'demo-3',
                    name: 'Sofia (S√≠ndrome de Down)',
                    adaptationDetails: JSON.stringify({
                        diagnosis: ['S√≠ndrome de Down'],
                        difficulties: ['coordena√ß√£o motora', 'compreens√£o'],
                        suggestions: ['elementos visuais', 'refor√ßo positivo']
                    }),
                    grade: 6
                }
            ];

            // Seleciona estudante aleat√≥rio
            const selectedStudent = demoStudents[Math.floor(Math.random() * demoStudents.length)];

            console.log('‚úÖ Estudante selecionado para demo:', selectedStudent.name);

            // Configura estado
            window.state.currentStudent = selectedStudent;

            // Avalia√ß√£o mock
            const mockAssessment = {
                id: 'demo-assessment',
                title: 'Avalia√ß√£o de Demonstra√ß√£o - Artes',
                baseText: 'Este √© um texto de apoio para demonstra√ß√£o do sistema adaptativo.',
                questions: [
                    {
                        id: 1,
                        question_text: 'O que √© cultura?',
                        options: [
                            { text: 'Conjunto de tradi√ß√µes de um povo', isCorrect: true },
                            { text: 'Apenas a m√∫sica de um pa√≠s', isCorrect: false },
                            { text: 'Somente as leis de uma na√ß√£o', isCorrect: false }
                        ]
                    }
                ]
            };

            // Inicia roteamento adaptativo
            await routeAssessment(mockAssessment);
        }

        async function startContentCreationTest() {
            console.log('üîß Iniciando cria√ß√£o de conte√∫do...');
            alert('üöß Funcionalidade de cria√ß√£o de conte√∫do em desenvolvimento!\\n\\nEm breve voc√™ poder√° criar e editar conte√∫dos adaptativos diretamente na interface.');
        }

        async function updateSystemStatus() {
            const statusGrid = document.getElementById('status-grid');

            // Testa componentes do sistema
            const forceMock = localStorage.getItem('forceMockData') === 'true';

            let supabaseStatus = false;
            let contentStatus = false;
            let gameStatus = true; // Sistema de jogos sempre dispon√≠vel

            if (!forceMock) {
                try {
                    // Testa Supabase
                    const classes = await dataService.getClassesByGrade(6);
                    supabaseStatus = classes && classes.length > 0;

                    // Testa conte√∫do adaptativo
                    if (supabaseStatus) {
                        const texts = await dataService.getAdaptiveSupportTexts('tea', 6);
                        contentStatus = texts && texts.length > 0;
                    }
                } catch (error) {
                    console.warn('Erro ao testar sistema:', error);
                }
            }

            statusGrid.innerHTML = `
                <div class="status-item ${supabaseStatus ? 'connected' : 'disconnected'}">
                    <div class="status-icon">${supabaseStatus ? 'üü¢' : 'üî¥'}</div>
                    <div class="status-label">Supabase</div>
                    <div class="status-value">${supabaseStatus ? 'Conectado' : 'Desconectado'}</div>
                </div>
                <div class="status-item ${contentStatus ? 'connected' : 'disconnected'}">
                    <div class="status-icon">${contentStatus ? 'üü¢' : 'üü°'}</div>
                    <div class="status-label">Conte√∫do Adaptativo</div>
                    <div class="status-value">${contentStatus ? 'Banco de dados' : 'Mock/Fallback'}</div>
                </div>
                <div class="status-item ${gameStatus ? 'connected' : 'disconnected'}">
                    <div class="status-icon">${gameStatus ? 'üü¢' : 'üî¥'}</div>
                    <div class="status-label">Sistema de Jogos</div>
                    <div class="status-value">${gameStatus ? '8 jogos dispon√≠veis' : 'Indispon√≠vel'}</div>
                </div>
                <div class="status-item ${forceMock ? 'disconnected' : 'connected'}">
                    <div class="status-icon">${forceMock ? 'üß™' : 'üíæ'}</div>
                    <div class="status-label">Modo de Dados</div>
                    <div class="status-value">${forceMock ? 'Mock/Demo' : 'Produ√ß√£o'}</div>
                </div>
            `;

            systemStatus = { supabase: supabaseStatus, adaptiveContent: contentStatus, gameSystem: gameStatus };
        }

        // Atualiza status a cada 30 segundos
        setInterval(updateSystemStatus, 30000);
    </script>
</body>
</html>