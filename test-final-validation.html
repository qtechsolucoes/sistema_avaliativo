<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valida√ß√£o Final - Sistema Centralizado</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }
        .test-result {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }
        button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        .btn-success { background: linear-gradient(45deg, #28a745, #20c997); }
        .btn-danger { background: linear-gradient(45deg, #dc3545, #e83e8c); }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #dee2e6;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .online { background-color: #28a745; color: white; }
        .offline { background-color: #dc3545; color: white; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>üß™ Valida√ß√£o Final do Sistema Centralizado</h1>
            <p>Verifica√ß√£o completa do sistema de bloqueio baseado exclusivamente no Supabase</p>
        </div>

        <div class="test-section">
            <h3>üîß Controles de Teste</h3>
            <button onclick="runFullValidation()" class="btn-success">üöÄ Executar Valida√ß√£o Completa</button>
            <button onclick="testConnectionOnly()">üîå Testar Apenas Conex√£o</button>
            <button onclick="testBlockingLogic()">üîí Testar L√≥gica de Bloqueio</button>
            <button onclick="clearResults()" class="btn-danger">üßπ Limpar Resultados</button>
        </div>

        <div id="progress-section" style="display: none;">
            <h4>üìä Progresso dos Testes</h4>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <p id="progress-text">Preparando testes...</p>
        </div>

        <div id="results"></div>

        <div class="test-section">
            <h3>üìã Checklist de Valida√ß√£o</h3>
            <ul id="validation-checklist">
                <li>üîå Conectividade com Supabase</li>
                <li>üìä Fun√ß√£o getCompletedSubmissions retorna apenas dados Supabase</li>
                <li>üîí Fun√ß√£o getCompletedStudentIds gera Set corretamente</li>
                <li>‚ö†Ô∏è Sistema ignora dados locais para bloqueio</li>
                <li>üìù Logs de debug funcionando</li>
                <li>üéØ Mensagens de "fonte √∫nica" aparecem</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { dataService } from './src/services/dataService.js';
        import { logService } from './src/services/logService.js';

        // Fun√ß√£o de bloqueio centralizado (c√≥pia da implementa√ß√£o real)
        async function getCompletedStudentIds(classId) {
            try {
                console.log('üîç Buscando estudantes completados APENAS no Supabase (fonte √∫nica de verdade)');

                // Busca submiss√µes completadas (agora s√≥ retorna dados do Supabase)
                const completedSubmissions = await dataService.getCompletedSubmissions(classId);

                // Retorna Set com IDs √∫nicos dos estudantes
                const completedIds = new Set(completedSubmissions.map(submission => submission.studentId));

                // Debug: Mostra IDs bloqueados
                console.log(`üîí Sistema centralizado: ${completedIds.size} estudantes bloqueados`);
                console.log('üìã IDs bloqueados:', Array.from(completedIds));

                return completedIds;

            } catch (error) {
                console.warn('Erro ao buscar estudantes completados:', error);
                return new Set();
            }
        }

        // Torna as fun√ß√µes globais
        window.runFullValidation = runFullValidation;
        window.testConnectionOnly = testConnectionOnly;
        window.testBlockingLogic = testBlockingLogic;
        window.clearResults = clearResults;

        let testProgress = 0;
        const totalTests = 6;

        function updateProgress(current, message) {
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const progressSection = document.getElementById('progress-section');

            progressSection.style.display = 'block';
            const percentage = (current / totalTests) * 100;
            progressFill.style.width = percentage + '%';
            progressText.textContent = message;
        }

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);

            // Auto-scroll para o resultado mais recente
            div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('progress-section').style.display = 'none';
            testProgress = 0;
        }

        async function runFullValidation() {
            clearResults();
            addResult('üöÄ <strong>Iniciando Valida√ß√£o Completa do Sistema Centralizado</strong>', 'info');

            try {
                // Teste 1: Conectividade
                updateProgress(1, 'Testando conectividade com Supabase...');
                await testConnectionOnly();

                // Teste 2: Fonte de dados
                updateProgress(2, 'Verificando fonte de dados...');
                await validateDataSource();

                // Teste 3: L√≥gica de bloqueio
                updateProgress(3, 'Testando l√≥gica de bloqueio...');
                await testBlockingLogic();

                // Teste 4: Logs do sistema
                updateProgress(4, 'Verificando logs do sistema...');
                await validateSystemLogs();

                // Teste 5: Integridade dos dados
                updateProgress(5, 'Verificando integridade dos dados...');
                await validateDataIntegrity();

                // Teste 6: Cen√°rios de falha
                updateProgress(6, 'Testando cen√°rios de falha...');
                await testFailureScenarios();

                updateProgress(6, 'Valida√ß√£o completa finalizada!');
                addResult('üéâ <strong>Valida√ß√£o Completa Finalizada!</strong>', 'success');

            } catch (error) {
                addResult(`‚ùå <strong>Erro durante valida√ß√£o:</strong> ${error.message}`, 'error');
            }
        }

        async function testConnectionOnly() {
            addResult('üîå <strong>Teste 1: Conectividade</strong>', 'info');

            try {
                const isOnline = await dataService.testConnection();
                if (isOnline) {
                    addResult(`‚úÖ Conex√£o com Supabase: <span class="status-badge online">ONLINE</span>`, 'success');
                } else {
                    addResult(`‚ö†Ô∏è Conex√£o com Supabase: <span class="status-badge offline">OFFLINE</span>`, 'warning');
                    addResult('‚ö†Ô∏è Sistema em modo offline - bloqueio centralizado n√£o funcionar√°', 'warning');
                }

                const status = await dataService.getServiceStatus();
                addResult(`üì° Servi√ßo ativo: ${status.activeService}`, 'info');

            } catch (error) {
                addResult(`‚ùå Erro ao testar conex√£o: ${error.message}`, 'error');
            }
        }

        async function validateDataSource() {
            addResult('üìä <strong>Teste 2: Fonte de Dados</strong>', 'info');

            try {
                const testClassId = '1';
                const submissions = await dataService.getCompletedSubmissions(testClassId);

                // Verificar se retorna apenas dados do Supabase
                const supabaseSubmissions = submissions.filter(s => s.source === 'supabase' || !s.isLocal);
                const localSubmissions = submissions.filter(s => s.isLocal);

                addResult(`üìä Total de submiss√µes encontradas: ${submissions.length}`, 'info');
                addResult(`üåê Submiss√µes do Supabase: ${supabaseSubmissions.length}`, 'info');
                addResult(`üíæ Submiss√µes locais: ${localSubmissions.length}`, 'info');

                if (localSubmissions.length === 0 || submissions.every(s => !s.isLocal)) {
                    addResult('‚úÖ Fonte de dados correta: Usando apenas Supabase', 'success');
                } else {
                    addResult('‚ö†Ô∏è Aten√ß√£o: Sistema encontrou dados locais', 'warning');
                }

            } catch (error) {
                addResult(`‚ùå Erro ao validar fonte de dados: ${error.message}`, 'error');
            }
        }

        async function testBlockingLogic() {
            addResult('üîí <strong>Teste 3: L√≥gica de Bloqueio</strong>', 'info');

            try {
                const testClassId = '1';
                const completedIds = await getCompletedStudentIds(testClassId);

                if (completedIds instanceof Set) {
                    addResult(`‚úÖ Retornou Set corretamente com ${completedIds.size} estudantes`, 'success');

                    if (completedIds.size > 0) {
                        addResult(`üìã IDs bloqueados: ${Array.from(completedIds).join(', ')}`, 'info');
                    } else {
                        addResult('‚ÑπÔ∏è Nenhum estudante bloqueado no momento', 'info');
                    }
                } else {
                    addResult('‚ùå Erro: N√£o retornou um Set', 'error');
                }

                // Testar alguns IDs espec√≠ficos
                const testIds = [1, 2, 3, 999];
                for (const id of testIds) {
                    const isBlocked = completedIds.has(id);
                    const status = isBlocked ? 'üîí BLOQUEADO' : '‚úÖ LIBERADO';
                    const type = isBlocked ? 'warning' : 'success';
                    addResult(`Estudante ID ${id}: ${status}`, type);
                }

            } catch (error) {
                addResult(`‚ùå Erro ao testar l√≥gica de bloqueio: ${error.message}`, 'error');
            }
        }

        async function validateSystemLogs() {
            addResult('üìù <strong>Teste 4: Logs do Sistema</strong>', 'info');

            // Capturar logs do console
            const originalLog = console.log;
            const originalWarn = console.warn;
            const logs = [];

            console.log = (...args) => {
                logs.push({ type: 'log', message: args.join(' ') });
                originalLog(...args);
            };

            console.warn = (...args) => {
                logs.push({ type: 'warn', message: args.join(' ') });
                originalWarn(...args);
            };

            try {
                // Executar fun√ß√£o que gera logs
                await getCompletedStudentIds('1');

                // Verificar se logs esperados est√£o presentes
                const centralizedLogs = logs.filter(log =>
                    log.message.includes('fonte √∫nica') ||
                    log.message.includes('Sistema centralizado') ||
                    log.message.includes('SISTEMA CENTRALIZADO')
                );

                if (centralizedLogs.length > 0) {
                    addResult('‚úÖ Logs do sistema centralizado funcionando', 'success');
                    centralizedLogs.forEach(log => {
                        addResult(`üìù Log: ${log.message}`, 'info');
                    });
                } else {
                    addResult('‚ö†Ô∏è Logs do sistema centralizado n√£o encontrados', 'warning');
                }

            } finally {
                // Restaurar console original
                console.log = originalLog;
                console.warn = originalWarn;
            }
        }

        async function validateDataIntegrity() {
            addResult('üîç <strong>Teste 5: Integridade dos Dados</strong>', 'info');

            try {
                const testClassId = '1';

                // Buscar dados duas vezes para verificar consist√™ncia
                const firstCall = await getCompletedStudentIds(testClassId);
                const secondCall = await getCompletedStudentIds(testClassId);

                const firstArray = Array.from(firstCall).sort();
                const secondArray = Array.from(secondCall).sort();

                if (JSON.stringify(firstArray) === JSON.stringify(secondArray)) {
                    addResult('‚úÖ Dados consistentes entre chamadas', 'success');
                } else {
                    addResult('‚ö†Ô∏è Inconsist√™ncia detectada entre chamadas', 'warning');
                }

                // Verificar se IDs s√£o v√°lidos
                const invalidIds = firstArray.filter(id => !Number.isInteger(id) || id <= 0);
                if (invalidIds.length === 0) {
                    addResult('‚úÖ Todos os IDs s√£o v√°lidos', 'success');
                } else {
                    addResult(`‚ùå IDs inv√°lidos encontrados: ${invalidIds.join(', ')}`, 'error');
                }

            } catch (error) {
                addResult(`‚ùå Erro ao validar integridade: ${error.message}`, 'error');
            }
        }

        async function testFailureScenarios() {
            addResult('üö® <strong>Teste 6: Cen√°rios de Falha</strong>', 'info');

            try {
                // Teste com classe inexistente
                const emptyResult = await getCompletedStudentIds('999999');
                if (emptyResult instanceof Set && emptyResult.size === 0) {
                    addResult('‚úÖ Classe inexistente retorna Set vazio', 'success');
                } else {
                    addResult('‚ö†Ô∏è Comportamento inesperado para classe inexistente', 'warning');
                }

                // Teste com par√¢metro inv√°lido
                const invalidResult = await getCompletedStudentIds(null);
                if (invalidResult instanceof Set) {
                    addResult('‚úÖ Par√¢metro inv√°lido tratado corretamente', 'success');
                } else {
                    addResult('‚ùå Par√¢metro inv√°lido n√£o tratado', 'error');
                }

            } catch (error) {
                addResult(`‚ùå Erro durante teste de falhas: ${error.message}`, 'error');
            }
        }

        // Auto-executar teste de conectividade ao carregar
        setTimeout(() => {
            addResult('üéØ <strong>Sistema de Valida√ß√£o Carregado</strong>', 'info');
            addResult('üìã Use os bot√µes acima para executar testes espec√≠ficos ou valida√ß√£o completa', 'info');
        }, 1000);
    </script>
</body>
</html>